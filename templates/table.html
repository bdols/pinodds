<!DOCTYPE html>
<html lang="en">
<head>
{% load staticfiles %}
{% load humanize %}
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<link href="{% static "bootstrap/css/bootstrap.min.css" %}" rel="stylesheet">
<script src="{% static "bootstrap/js/bootstrap.min.js" %}"></script>
<script>
function processBet(data,i){
    var idx=i+1;
    $("#"+idx+"time").text(data.at_time);
    $("#"+idx+"comment").text(data.comment);
    if (data.position) {
        $("#"+idx+"machine").text(data.machine + " at " + data.at_odds + ":1");
    } else {
        $("#"+idx+"machine").text("Against " + data.machine + " at " + data.at_odds + ":1");
    }
    $("#"+idx+"user").text(data.user);
}

function process(data) {
    for (var idx=0; idx<data.bets.length; ++idx) {
        processBet(data.bets[idx],idx);
    }
}
function refreshbets() {
    $.getJSON("/last5/",function (data) { 
        process(data);
    }); 
}
window.setInterval(refreshbets,10000);
$(document).ready(function () {
refreshbets;
$('#betmodal').on('hidden.bs.modal', function () {
    var ff= $(this).attr("id");
});

});
</script>
</head>
<body>
    <div class="row">
        <div class="span1 offset2">
        {% if user.is_authenticated %}
            <a href={% url 'django.contrib.auth.views.logout_then_login' %}>Log out</a>
        {% else %}
            <a href={% url 'django.contrib.auth.views.login' %}>Log in</a>
        {% endif %}
        </div>
        <div id="status" class="span-3">
        {% if user.is_authenticated %}
        Logged in as {{ user.username }}
        {% else %}
        <B>Not logged in</B>
        {% endif %}
         </div>
        {% if not user.is_authenticated %}
        <div id="register" class="span-2">
            <a href={% url 'registration_register' %}>Register</a>
        </div>
        {% endif %}
    </div>
    <div class="row">
        <div class="span8 offset1"><h3>Last 5 bets</h3></div>
    </div>
    <div class="row">
        <div class="span1"><h5>User</h5></div>
        <div class="span5"><h5>Bet</h5></div>
        <div class="span3"><h5>Time</h5></div>
        <div class="span6"><h5>Comment</h5></div>
    </div>
    <div id="last5">
    {% for bet in last5bets %}
    <div class="row">
        <div id={{forloop.counter}}user class="span1">{{ bet.user }}</div>
        {% include "bet.html" %}
    </div>
    {% endfor %}
    </div>
    {% for user in users %}
    <div class="row">
        <div class="span1">{{ user }}</div>
        <div class="span1">{{ user.total_bets }}</div>
        <div class="span1">{{ user.bet_count }}</div>
        <div class="span1">{{ user.reverse_bet_count }}</div>
    </div>
    {% for bet in user.bet_set.all %}
    <div class="row">
        <div class="span1"></div>
        {% include "bet.html" %}
    </div>
    {% endfor %}
    {% endfor %}
    <div class="row">
        <div class="span4 offset1">Machine</div>
        <div class="span2">Odds in tourney</div>
        <div class="span2">Bets for</div>
        <div class="span2">Odds not in tourney</div>
        <div class="span2">Bets against</div>
    </div>
    <div class="modal fade" id="betmodal" role="dialog" aria-labelledby="bet model label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="myModalLabel">What's your bet?</h4>
                </div>
                <div class="modal-body">
                    <div id="machid" style="display: none"></div>
                    <div id="machname"></div>
                    <div id="odds"></div>
                    <div id="rodds" style="display:none"></div>
                    <input type="text" class="form-control" placeholder="# of pinbucks" id="value"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>
<script>
    function populate(counter,machid) {
        $('#machid').text(machid);
        $('#machname').text($('#'+counter+'mach').text());
        $('#odds').text($('#'+counter+'odds').text());
        $('#rodds').text($('#'+counter+'rodds').text());
    }
</script>
{% for machine in machines %}
    <p>
    <div class="row">
        <div id={{ forloop.counter}}betbutton class="span1">
            <button type="button" data-toggle="modal" onClick="populate({{forloop.counter}}, {{machine.id}});" data-target="#betmodal" class="btn btn-primary">Bet</button>
        </div>
        <div id={{ forloop.counter }}mach class="span4">{{ machine.name }}</div>
        <div id={{ forloop.counter }}odds class="span2">{{ machine.current_odds }}:1</div>
        <div id={{ forloop.counter }}betcount class="span2">{{ machine.bet_count}}</div>
        <div id={{ forloop.counter }}rodds class="span2">{{ machine.current_reverse_odds }}:1</div>
        <div id={{ forloop.counter }}rbetcount class="span2">{{ machine.reverse_bet_count}}</div>
        <div id={{ forloop.counter }}aodds class="span2">{{ machine.odds_against}}:1</div>
        <!-- add pending -->
    </div>
{% endfor %}
</body>
</html>
